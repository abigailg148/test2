<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            background-color: #70c5ce;
            font-family: Arial, sans-serif;
        }

        h1 {
            font-size: 36px;
            color: white;
            margin-top: 20px;
            text-shadow: 2px 2px 5px #000;
        }

        .game-container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
        }

        canvas {
            border: 2px solid black;
            background-color: #f3f3f3;
        }

        #leaderboard-container {
            width: 220px;
            margin-right: 20px;
            text-align: left;
            background-color: #f8f9fa;
            border: 2px solid black;
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
            height: 480px; /* Match canvas height */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        #controls-container {
            width: 220px;
            margin-left: 20px;
            text-align: left;
            background-color: #f8f9fa;
            border: 2px solid black;
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
            height: 480px; /* Match canvas height */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        #retry-btn {
            display: none;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }

        #retry-btn:hover {
            background-color: #45a049;
        }

        #name-input {
            margin-top: 20px;
            width: 100%;
            padding: 5px;
            font-size: 14px;
        }

        #submit-btn {
            margin-top: 10px;
            width: 100%;
            padding: 5px;
            font-size: 14px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }

        #submit-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <!-- Game Title -->
    <h1>Bird Game</h1>

    <!-- Game Content -->
    <div class="game-container">
        <!-- Leaderboard -->
        <div id="leaderboard-container">
            <h3>Leaderboard</h3>
            <div id="leaderboard"></div>
        </div>

        <!-- Game Canvas -->
        <div>
            <canvas id="gameCanvas" width="320" height="480"></canvas>
        </div>

        <!-- Retry Button and Score Input -->
        <div id="controls-container">
            <button id="retry-btn">Retry</button>
            <input type="text" id="name-input" placeholder="Enter your name" />
            <button id="submit-btn">Submit Score</button>
        </div>
    </div>

    <script>
        // Canvas Setup
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // Retry Button Setup
        const retryBtn = document.getElementById("retry-btn");
        retryBtn.addEventListener("click", startGame);

        // Score Variables
        let score = 0;
        let playerName = "";

        // Game Variables
        let birdWidth = 30;
        let birdHeight = 30;
        let birdX = 50;
        let birdY = 150;
        let birdSpeed = 0;
        const gravity = 0.75;
        const lift = -12;
        let isGameOver = false;
        let pipes = [];

        // Button to submit score
        const submitBtn = document.getElementById("submit-btn");
        submitBtn.addEventListener("click", submitScore);

        // Game initialization
        function startGame() {
            birdY = 150;
            birdSpeed = 0;
            pipes = [];
            score = 0; // Reset score
            isGameOver = false;
            retryBtn.style.display = "none"; // Hide retry button
            gameLoop(); // Start the game loop
        }

        // Event listener for jump
        document.addEventListener('keydown', function(e) {
            if (e.key === " " && !isGameOver) {
                birdSpeed = lift;
            }
        });

        // Game Loop
        function gameLoop() {
            if (isGameOver) {
                return gameOver();
            }

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Bird logic
            birdSpeed += gravity;
            birdY += birdSpeed;

            // Draw bird
            ctx.fillStyle = "yellow";
            ctx.fillRect(birdX, birdY, birdWidth, birdHeight);

            // Pipe logic
            if (pipes.length === 0 || pipes[pipes.length - 1].x < canvas.width - 200) {
                let pipeHeight = Math.floor(Math.random() * (canvas.height - 150));
                pipes.push({x: canvas.width, top: pipeHeight, bottom: pipeHeight + 150});
            }

            pipes.forEach((pipe, index) => {
                pipe.x -= 3;
                ctx.fillStyle = "green";
                ctx.fillRect(pipe.x, 0, 50, pipe.top); // Top pipe
                ctx.fillRect(pipe.x, pipe.bottom, 50, canvas.height - pipe.bottom); // Bottom pipe

                // Check for collision
                if (birdX + birdWidth > pipe.x && birdX < pipe.x + 50) {
                    if (birdY < pipe.top || birdY + birdHeight > pipe.bottom) {
                        isGameOver = true;
                    }
                }

                // Increment score when bird passes a pipe
                if (pipe.x + 50 < birdX && !pipe.passed) {
                    score++;
                    pipe.passed = true;
                }

                // Remove pipes that are off-screen
                if (pipe.x + 50 < 0) {
                    pipes.splice(index, 1);
                }
            });

            // Draw score on canvas
            ctx.fillStyle = "black"; // Set text color
            ctx.font = "30px Arial"; // Set font
            ctx.fillText("Score: " + score, 20, 40); // Draw score

            // Check if bird hits the ground or goes above the screen
            if (birdY + birdHeight > canvas.height || birdY < 0) {
                isGameOver = true;
            }

            // Request next frame
            requestAnimationFrame(gameLoop);
        }

        // Game Over
        function gameOver() {
            ctx.fillStyle = "black";
            ctx.font = "30px Arial";
            ctx.fillText("Game Over!", canvas.width / 4, canvas.height / 2);
            retryBtn.style.display = "block"; // Show retry button
        }

        // Submit score to the server
        function submitScore() {
            playerName = document.getElementById("name-input").value;
            if (!playerName || score === 0) {
                alert("Please enter your name and play the game!");
                return;
            }

            // Send score to the server
            fetch('/submit-score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: playerName, score: score }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("Score submitted!");
                fetchLeaderboard(); // Refresh leaderboard after submission
            })
            .catch(error => {
                console.error("Error submitting score:", error);
            });
        }

        // Fetch and display leaderboard
        function fetchLeaderboard() {
            fetch('/get-leaderboard') // Replace with your backend endpoint
                .then(response => response.json())
                .then(data => {
                    displayLeaderboard(data);
                })
                .catch(error => {
                    console.error("Error fetching leaderboard:", error);
                    let leaderboard = document.getElementById("leaderboard");
                    leaderboard.innerHTML = "<p>Error loading leaderboard.</p>";
                });
        }

        // Display the leaderboard
        function displayLeaderboard(data) {
            let leaderboard = document.getElementById("leaderboard");
            leaderboard.innerHTML = ""; // Clear previous content

            // Sort and display the top 10 scores
            const topScores = data.sort((a, b) => b.score - a.score).slice(0, 10);
            topScores.forEach((entry, index) => {
                leaderboard.innerHTML += `<p>${index + 1}. ${entry.name}: ${entry.score}</p>`;
            });
        }

        // Start the game for the first time
        fetchLeaderboard(); // Load leaderboard at the beginning
        startGame();
    </script>
</body>
</html>
